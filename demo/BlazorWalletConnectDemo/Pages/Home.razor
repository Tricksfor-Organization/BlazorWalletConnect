@page "/"
@inject IWalletConnectInterop WalletConnect
@using System.Numerics

<PageTitle>BlazorWalletConnect Demo</PageTitle>

<div class="demo-container">
    <div class="demo-header">
        <h1>ðŸ”— BlazorWalletConnect Demo</h1>
        <p>A Progressive Web App demonstrating Web3 wallet integration in Blazor</p>
    </div>

    <div class="wallet-section">
        <h2>Connect Your Wallet</h2>
        <p>Click the button below to connect your Web3 wallet using WalletConnect protocol:</p>
        
        <div style="margin: 2rem 0; display: flex; flex-direction: column; align-items: center; gap: 1rem;">
            <WalletConnectButton Label="Connect Wallet" ShowBalance="true" />
            
            <div style="width: 100%; max-width: 300px; height: 1px; background: linear-gradient(to right, transparent, #ddd, transparent); margin: 0.5rem 0;"></div>
            
            <div style="display: flex; align-items: center; gap: 1rem; flex-wrap: wrap; justify-content: center;">
                <button class="btn-primary" @onclick="GetBalanceAsync" disabled="@isLoadingBalance">
                    @if (isLoadingBalance)
                    {
                        <span>Loading...</span>
                    }
                    else
                    {
                        <span>ðŸ’° Get Balance</span>
                    }
                </button>
                
                @if (!string.IsNullOrEmpty(balanceMessage))
                {
                    <div style="padding: 0.5rem 1rem; background: #f0f9ff; border-left: 4px solid #0284c7; border-radius: 4px;">
                        <strong>Balance:</strong> @balanceMessage
                    </div>
                }
            </div>
        </div>

        @if (!string.IsNullOrEmpty(errorMessage))
        {
            <div style="margin: 1rem 0; padding: 1rem; background: #fef2f2; border-left: 4px solid #dc2626; border-radius: 4px;">
                <strong>Error:</strong> @errorMessage
            </div>
        }

        <div class="info-card">
            <h3>ðŸ“± About This Demo</h3>
            <p>This is a Progressive Web App (PWA) built with Blazor WebAssembly that demonstrates the BlazorWalletConnect library.</p>
            <p>The library provides seamless integration with Web3 wallets through the WalletConnect protocol.</p>
        </div>
    </div>

    <div class="wallet-section">
        <h2>Features</h2>
        <div class="info-card">
            <h3>âœ¨ What's Included</h3>
            <ul class="feature-list">
                <li>Easy wallet connection with WalletConnect protocol</li>
                <li>Support for multiple blockchain networks (Ethereum, Polygon, etc.)</li>
                <li>Account balance display</li>
                <li>Chain switching support</li>
                <li>Transaction handling capabilities</li>
                <li>Responsive design for mobile and desktop</li>
                <li>PWA support for offline functionality</li>
            </ul>
        </div>
    </div>

    <div class="wallet-section">
        <h2>Getting Started</h2>
        <div class="info-card">
            <h3>ðŸš€ Setup Instructions</h3>
            <p><strong>1. Get a WalletConnect Project ID:</strong></p>
            <p>Visit <a href="https://cloud.walletconnect.com/" target="_blank">WalletConnect Cloud</a> and create a free project to get your Project ID.</p>
            
            <p><strong>2. Update the configuration:</strong></p>
            <p>Set your Project ID in <code>appsettings.json</code> or via <a href="https://learn.microsoft.com/en-us/aspnet/core/security/app-secrets" target="_blank">user secrets</a>. The application will read the Project ID from configuration.</p>
            
            <p><strong>3. Optional - Configure RPC URLs:</strong></p>
            <p>Replace <code>YOUR_INFURA_KEY</code> with your Infura API key or use public RPC endpoints.</p>
        </div>
    </div>

    <div class="wallet-section">
        <h2>Usage</h2>
        <div class="info-card">
            <h3>ðŸ’» Code Example</h3>
            <p>To add the WalletConnect button to your Blazor page:</p>
            <pre style="background: #f4f4f4; padding: 1rem; border-radius: 4px; overflow-x: auto;"><code>&lt;WalletConnectButton Label="Connect Wallet" ShowBalance="true" /&gt;</code></pre>
            
            <p>Configure the service in your <code>Program.cs</code>:</p>
            <pre style="background: #f4f4f4; padding: 1rem; border-radius: 4px; overflow-x: auto;"><code>builder.Services.AddBlazorWalletConnect(options =>
{
    options.ProjectId = "YOUR_PROJECT_ID";
    options.Name = "Your App Name";
    options.Description = "Your app description";
    // ... other configuration
});</code></pre>
        </div>
    </div>

    <div class="wallet-section" style="text-align: center;">
        <p>
            <strong>Need help?</strong> Check out the 
            <a href="https://github.com/Tricksfor-Organization/BlazorWalletConnect" target="_blank">GitHub repository</a> 
            for documentation and examples.
        </p>
    </div>
</div>

@code {
    private bool isLoadingBalance = false;
    private string? balanceMessage;
    private string? errorMessage;

    private async Task GetBalanceAsync()
    {
        isLoadingBalance = true;
        errorMessage = null;
        balanceMessage = null;

        try
        {
            var balance = await WalletConnect.GetBalanceAsync();
            
            if (balance != null)
            {
                var formatted = ConvertToDecimal(balance.Value, balance.Decimals);
                balanceMessage = $"{formatted} {balance.Symbol}";
            }
            else
            {
                errorMessage = "Unable to retrieve balance. Please ensure your wallet is connected.";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to get balance: {ex.Message}";
        }
        finally
        {
            isLoadingBalance = false;
        }
    }

    static decimal ConvertToDecimal(BigInteger value, int decimalPlacesToUnit)
    {
        if(decimalPlacesToUnit == 0)
            return Nethereum.Util.UnitConversion.Convert.FromWei(value);
        else
            return Nethereum.Util.UnitConversion.Convert.FromWei(value, decimalPlacesToUnit);
    }
    static BigInteger ConvertToBigInteger(decimal value, int decimalPlacesToUnit)
    {
        if(decimalPlacesToUnit == 0)
            return Nethereum.Util.UnitConversion.Convert.ToWei(value);
        else
            return Nethereum.Util.UnitConversion.Convert.ToWei(value, decimalPlacesToUnit);
    }
}
