name: Deploy Demo to Cloudflare Pages

env:
  DEMO_PROJECT_PATH: demo/BlazorWalletConnectDemo
  DEMO_PROJECT_NAME: BlazorWalletConnectDemo

on:
  release:
    types: [published, created]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: false
        default: 'production'
        type: choice
        options:
          - production
          - preview

permissions:
  contents: read
  deployments: write

jobs:
  build-and-deploy:
    name: Build and Deploy Demo to Cloudflare Pages
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'

      - name: Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/Directory.Packages.props', '**/*.csproj') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      - name: Cache npm packages
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-npm-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-npm-

      - name: Restore dependencies
        run: dotnet restore

      - name: Build library project
        run: dotnet build src/BlazorWalletConnect/BlazorWalletConnect.csproj --configuration Release --no-restore

      - name: Publish demo application
        run: |
          dotnet publish ${{ env.DEMO_PROJECT_PATH }}/${{ env.DEMO_PROJECT_NAME }}.csproj \
            --configuration Release \
            --output ./publish \
            --no-restore

      - name: Inject WalletConnect ProjectId into appsettings
        env:
          WALLETCONNECT_PROJECT_ID: ${{ secrets.DEMO_WALLETCONNECT_PROJECT_ID }}
        run: |
          # Update appsettings.json with the ProjectId from GitHub secrets
          if [ -f "./publish/wwwroot/appsettings.json" ]; then
            echo "Injecting WalletConnect ProjectId into appsettings.json"
            jq --arg projectId "$WALLETCONNECT_PROJECT_ID" \
              '.WalletConnect.ProjectId = $projectId' \
              ./publish/wwwroot/appsettings.json > ./publish/wwwroot/appsettings.tmp.json
            mv ./publish/wwwroot/appsettings.tmp.json ./publish/wwwroot/appsettings.json
          else
            echo "Warning: appsettings.json not found"
          fi

      - name: Configure base path for Cloudflare Pages
        run: |
          # Update index.html to use correct base path
          # Cloudflare Pages serves from root by default
          echo "Checking published files..."
          ls -la ./publish/wwwroot/
          echo ""
          echo "Checking for service worker files..."
          if [ -f "./publish/wwwroot/service-worker.js" ]; then
            echo "âœ“ service-worker.js found"
          else
            echo "âœ— service-worker.js NOT found"
          fi
          if [ -f "./publish/wwwroot/service-worker-assets.js" ]; then
            echo "âœ“ service-worker-assets.js found"
          else
            echo "âœ— service-worker-assets.js NOT found - checking for published version"
          fi
          if [ -f "./publish/wwwroot/service-worker.published.js" ]; then
            echo "âœ“ service-worker.published.js found"
          else
            echo "âœ— service-worker.published.js NOT found"
          fi

      - name: Use published service worker if available
        run: |
          # Use the published version of service worker if it exists (it's optimized for production)
          if [ -f "./publish/wwwroot/service-worker.published.js" ]; then
            echo "Using service-worker.published.js as service-worker.js"
            cp ./publish/wwwroot/service-worker.published.js ./publish/wwwroot/service-worker.js
          fi
          
          # Fix globalThis to self in service worker files (service workers use 'self' not 'globalThis')
          for sw_file in ./publish/wwwroot/service-worker*.js; do
            if [ -f "$sw_file" ]; then
              echo "Fixing globalThis to self in $sw_file"
              sed -i 's/globalThis\./self./g' "$sw_file"
              sed -i 's/globalThis,/self,/g' "$sw_file"
              
              # Ensure importScripts is present in service-worker.js
              if [[ "$sw_file" == *"service-worker.js" ]] && ! grep -q "importScripts" "$sw_file"; then
                echo "Adding importScripts to $sw_file"
                sed -i '3a self.importScripts('\''./service-worker-assets.js'\'');' "$sw_file"
              fi
            fi
          done
          
          # Verify service-worker-assets.js exists, if not create a minimal one
          if [ ! -f "./publish/wwwroot/service-worker-assets.js" ]; then
            echo "Creating minimal service-worker-assets.js"
            echo 'self.assetsManifest = { "assets": [], "version": "1.0.0" };' > ./publish/wwwroot/service-worker-assets.js
          fi

      - name: Add _headers file for proper MIME types
        run: |
          cat > ./publish/wwwroot/_headers << 'EOF'
          # Default headers for all routes
          /*
            X-Frame-Options: SAMEORIGIN
            X-Content-Type-Options: nosniff
            Referrer-Policy: strict-origin-when-cross-origin

          # CSS files
          /*.css
            Content-Type: text/css
            Cache-Control: public, max-age=31536000, immutable

          # JavaScript files
          /*.js
            Content-Type: application/javascript
            Cache-Control: public, max-age=31536000, immutable

          # WebAssembly files
          /*.dll
            Content-Type: application/wasm
            Cache-Control: public, max-age=31536000, immutable

          /*.wasm
            Content-Type: application/wasm
            Cache-Control: public, max-age=31536000, immutable

          # JSON files
          /*.json
            Content-Type: application/json
            Cache-Control: public, max-age=3600

          # Images
          /*.png
            Content-Type: image/png
            Cache-Control: public, max-age=31536000, immutable

          /*.ico
            Content-Type: image/x-icon
            Cache-Control: public, max-age=31536000, immutable

          # Service Worker (no cache, must revalidate)
          /service-worker.js
            Content-Type: application/javascript
            Cache-Control: public, max-age=0, must-revalidate

          /service-worker-assets.js
            Content-Type: application/javascript
            Cache-Control: public, max-age=0, must-revalidate
          EOF

      - name: Add _redirects file for SPA routing
        run: |
          cat > ./publish/wwwroot/_redirects << 'EOF'
          # Static files - serve directly without redirect
          /css/*    200!
          /js/*     200!
          /_framework/*    200!
          /_content/*    200!
          /service-worker.js    200!
          /service-worker-assets.js    200!
          /manifest.json    200!
          /icon-*.png    200!
          /favicon.ico    200!
          /*.css    200!
          /*.js    200!
          /*.dll    200!
          /*.wasm    200!
          /*.json    200!
          /*.png    200!
          /*.ico    200!
          
          # SPA fallback - serve index.html for everything else
          /*    /index.html   200
          EOF

      - name: Add error handling to service worker registration
        run: |
          # Update index.html to have better error handling for service worker
          sed -i 's|<script>navigator.serviceWorker.register('"'"'service-worker.js'"'"');</script>|<script>if ('"'"'serviceWorker'"'"' in navigator) { navigator.serviceWorker.register('"'"'service-worker.js'"'"').catch(err => console.log('"'"'Service worker registration failed:'"'"', err)); }</script>|g' ./publish/wwwroot/index.html

      - name: Install Wrangler CLI
        run: npm install -g wrangler

      - name: Create Cloudflare Pages project if not exists
        continue-on-error: true
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          # Try to create the project (will fail if it already exists, which is fine)
          curl -X POST "https://api.cloudflare.com/client/v4/accounts/$CLOUDFLARE_ACCOUNT_ID/pages/projects" \
            -H "Authorization: Bearer $CLOUDFLARE_API_TOKEN" \
            -H "Content-Type: application/json" \
            -d '{
              "name": "blazorwalletconnect-demo",
              "production_branch": "main"
            }' || echo "Project may already exist, continuing..."

      - name: Deploy to Cloudflare Pages using Wrangler
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          npx wrangler pages deploy ./publish/wwwroot \
            --project-name=blazorwalletconnect-demo \
            --branch=${{ github.head_ref || github.ref_name }} \
            --commit-hash=${{ github.sha }} \
            --commit-message="${{ github.event.release.name || github.event.head_commit.message || 'Manual deployment' }}"

      - name: Output deployment URL
        run: |
          echo "ðŸš€ Demo deployed to production: https://blazorwalletconnect-demo.pages.dev"
          if [ -n "${{ github.event.release.tag_name }}" ]; then
            echo "ï¿½ Release version: ${{ github.event.release.tag_name }}"
          fi

      - name: Create deployment summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          ## ðŸŽ‰ Demo Deployment Successful

          ### Deployment Details
          - **Release:** ${{ github.event.release.tag_name || 'Manual Deployment' }}
          - **Release Name:** ${{ github.event.release.name || 'N/A' }}
          - **Commit:** ${{ github.sha }}
          - **Triggered by:** ${{ github.event_name }}

          ### URLs
          - **Production URL:** https://blazorwalletconnect-demo.pages.dev
          - **Project Dashboard:** https://dash.cloudflare.com/

          ### Release Notes
          ${{ github.event.release.body || 'No release notes provided' }}

          ### Next Steps
          1. Test the deployed application
          2. Verify wallet connectivity
          3. Check browser console for any errors
          4. Validate new features from the release
          EOF
