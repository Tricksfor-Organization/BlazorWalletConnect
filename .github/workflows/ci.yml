name: CI

env:
  # Optional secret to prefix the package id (e.g. Tricksfor). Leave unset to keep project name as-is.
  NUGET_PACKAGE_PREFIX: ${{ secrets.NUGET_PACKAGE_PREFIX }}
  NUGET_API_KEY: ${{ secrets.NUGET_API_KEY }}
  APPLICATION_NAME: BlazorWalletConnect


on:
  push:
    # run on pushes to any branch and on tag pushes matching v*.*.*
    branches: ['**']
    tags: ['v*.*.*']
  pull_request:
    # run on PRs targeting any branch
    branches: ['**']
  release:
    types: [published]

permissions:
  contents: read

jobs:
  build:
    name: Build and Test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'

      - name: Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/Directory.Packages.props', '**/*.csproj') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      - name: Cache npm packages
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-npm-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-npm-

      - name: Restore dependencies
        run: dotnet restore

      - name: Build solution
        run: dotnet build --configuration Release --no-restore

      - name: Run tests
        run: |
          set -euo pipefail
          if find . -type f -name '*.Tests.csproj' -print -quit | grep -q .; then
            dotnet test --configuration Release --no-build --verbosity normal --logger "trx;LogFileName=test-results.trx"
          else
            echo "No test projects found. Skipping tests."
          fi

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: '**/test-results.trx'

  package:
    name: Create and Publish NuGet Package
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'release' && github.event.action == 'published'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'

      - name: Restore dependencies
        run: dotnet restore

      - name: Build solution
        run: dotnet build --configuration Release --no-restore

      - name: Compute package version from release tag
        run: |
          # Use the release tag as the package version. Strip a leading 'v' if present.
          tag="${{ github.event.release.tag_name }}"
          if [[ "$tag" == v* ]]; then
            tag="${tag#v}"
          fi
          echo "Computed PACKAGE_VERSION=$tag"
          echo "PACKAGE_VERSION=$tag" >> $GITHUB_ENV

      - name: Pack NuGet package
        run: |
          # Compute package ID using optional prefix. Do not fail if prefix is empty.
          if [ -n "${PACKAGE_VERSION:-}" ]; then
            echo "Packing with version $PACKAGE_VERSION"
          fi

          # Use shell environment variables inside the run script. These are populated
          # from the workflow-level `env:` (which can include secrets).
          if [ -n "${NUGET_PACKAGE_PREFIX:-}" ]; then
            PACKAGE_ID="${NUGET_PACKAGE_PREFIX}.${APPLICATION_NAME}"
          else
            PACKAGE_ID="${APPLICATION_NAME}"
          fi

          echo "Using PackageId=$PACKAGE_ID"

          if [ -n "${PACKAGE_VERSION:-}" ]; then
            dotnet pack src/${{ env.APPLICATION_NAME }}/${{ env.APPLICATION_NAME }}.csproj \
              -c Release -o ./nupkgs --no-build \
              /p:PackageVersion=$PACKAGE_VERSION /p:PackageId="$PACKAGE_ID"
          else
            dotnet pack src/${{ env.APPLICATION_NAME }}/${{ env.APPLICATION_NAME }}.csproj \
              -c Release -o ./nupkgs --no-build \
              /p:PackageId="$PACKAGE_ID"
          fi

      - name: Publish NuGet package
        run: |
          echo "Publishing packages found in ./nupkgs"
          ls -la ./nupkgs || true
          dotnet nuget push ./nupkgs/*.nupkg \
            -k ${{ env.NUGET_API_KEY }} \
            -s https://api.nuget.org/v3/index.json \
            --skip-duplicate

      - name: Upload NuGet package artifact
        uses: actions/upload-artifact@v4
        with:
          name: nuget-package
          path: ./nupkgs/*.nupkg

  code-quality:
    name: Code Quality Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'

      - name: Restore dependencies
        run: dotnet restore

      - name: Check code formatting
        run: dotnet format --verify-no-changes --verbosity diagnostic

  security:
    name: Security Scan
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'
